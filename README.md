# 晨雾监测系统 (Morning Mist Monitor)

一个专为摄影师和气象爱好者设计的智能晨雾预测和监测系统，基于天文学和气象学算法，精确预测晨雾发生概率和最佳摄影时刻。

## 🌅 核心功能

### 晨雾/平流雾概率预测

系统基于多个气象指标，采用科学算法计算晨雾和平流雾的发生概率：

- **晨雾（辐射雾）预测**：基于地面辐射冷却条件，考虑相对湿度、微风、温度-露点差值、温度趋势和云量等因素
- **平流雾预测**：基于暖湿气流流向冷表面的条件，考虑高湿度、适中风速、温度-露点差值和云量
- **风险等级评估**：将预测结果分为低、中、高三个风险等级，便于用户快速判断

### 日出时间与摄影时刻

精确计算日出时间和摄影黄金时刻：

- **日出时间**：基于天文学公式，精确到分钟
- **蓝调时刻**（Blue Hour）：日出前30分钟至日出后20分钟，天空呈现深蓝色
- **金色时刻**（Golden Hour）：日出前10分钟至日出后60分钟，阳光呈现金黄色
- **交互式时间轴**：可视化展示各个时刻，鼠标悬停显示具体时间

### 详细气象数据展示

小时级气象数据，帮助用户全面了解天气条件：

- 温度、相对湿度、露点、风速、天气代码、云量
- 温度-露点差值计算
- 关键指标高亮显示（高湿度、微风、温度-露点差值小、雾天气）
- 表格和图表双重展示

### 大气云层剖面图

直观展示不同高度的云层覆盖率：

- **低云层**（0-2000米）：层积云、层云、积云等
- **中云层**（2000-6000米）：高层云、高积云等
- **高云层**（6000米以上）：卷云、卷层云、卷积云等
- **云层变化趋势**：展示日出前后1小时内各层云量的变化

### 地点配置功能

用户可自定义监测地点：

- 地点名称、纬度、经度（WGS-84坐标系）
- 自动获取海拔（集成Open-Meteo Elevation API）
- 时区选择
- 地点列表管理

### 算法模型说明

详细的算法文档和说明：

- 日出时间计算算法（年积日、太阳赤纬角、时角、UTC时间转换）
- 晨雾/平流雾概率计算算法
- 摄影时刻计算方法
- 云层高度信息和海拔修正
- 算法精度和局限性说明

## 🛠️ 技术栈

### 前端
- **框架**：React 19 + Vite
- **样式**：Tailwind CSS 4
- **UI组件**：shadcn/ui
- **图表**：Recharts
- **图标**：Lucide Icons
- **包管理**：pnpm

### 后端
- **运行时**：Node.js 22
- **框架**：Express 4
- **API**：tRPC 11
- **数据库**：MySQL 8.0 / TiDB
- **ORM**：Drizzle ORM
- **认证**：Manus OAuth

### 部署
- **容器化**：Docker + Docker Compose
- **反向代理**：Nginx
- **数据库**：MySQL 8.0-alpine

## 🚀 快速开始

### 开发环境

```bash
# 安装依赖
pnpm install

# 启动开发服务器
pnpm dev

# 访问应用
# http://localhost:3000
```

### 生产部署

详见 [DEPLOYMENT.md](./DEPLOYMENT.md)

```bash
# 配置环境变量
cp .env.example .env
# 编辑 .env 文件

# 启动 Docker 容器
docker-compose up -d

# 访问应用
# http://localhost
```

## 📊 项目结构

```
morning_mist_monitor/
├── client/                 # 前端应用
│   ├── src/
│   │   ├── pages/         # 页面组件
│   │   ├── components/    # UI组件
│   │   ├── contexts/      # React上下文
│   │   ├── hooks/         # 自定义Hook
│   │   ├── lib/           # 工具函数
│   │   ├── App.tsx        # 应用入口
│   │   └── main.tsx       # React挂载点
│   ├── public/            # 静态资源
│   └── index.html         # HTML模板
├── server/                # 后端应用
│   ├── routers.ts         # tRPC路由定义
│   ├── db.ts              # 数据库查询助手
│   └── _core/             # 核心框架代码
├── shared/                # 共享代码
│   ├── algorithms.ts      # 核心算法模块
│   └── const.ts           # 常量定义
├── drizzle/               # 数据库schema
│   └── schema.ts          # 表结构定义
├── Dockerfile             # Docker镜像配置
├── docker-compose.yml     # Docker编排配置
├── nginx.conf             # Nginx配置
├── init.sql               # 数据库初始化脚本
└── README.md              # 本文件
```

## 🔧 核心算法

### 日出时间计算

基于天文学公式，计算给定日期和地点的日出时间：

1. **年积日计算**：根据日期计算该年的第几天（1-366）
2. **太阳赤纬角**：δ = 23.44° × sin(360° × (284 + n) / 365)
3. **时角计算**：cos(H) = -tan(φ) × tan(δ)，其中φ为纬度
4. **UTC时间**：结合修正方程和经度
5. **本地时间转换**：根据时区偏移调整

**精度**：±2-3分钟

### 晨雾概率计算

基于以下因素加权计算：

| 因素 | 权重 | 条件 |
|------|------|------|
| 相对湿度 | 40% | ≥80% |
| 微风 | 30% | ≤3 m/s |
| 温度-露点差 | 20% | ≤3°C |
| 温度趋势 | 10% | 下降趋势 |
| 云量 | 5% | ≤20% |

### 平流雾概率计算

基于以下因素加权计算：

| 因素 | 权重 | 条件 |
|------|------|------|
| 相对湿度 | 40% | ≥80% |
| 风速 | 35% | 2-6 m/s |
| 温度-露点差 | 15% | ≤3°C |
| 云量 | 10% | 30-70% |

### 海拔修正

每升高100米，低云层覆盖率降低约1-2%：

```
adjustedLowCloud = lowCloud - (altitude / 100) * 0.015
```

## 🌐 API集成

### Open-Meteo Weather API

获取实时和预报气象数据：

- 温度、湿度、露点、风速
- 天气代码和描述
- 云量数据（低、中、高三层）
- 全球覆盖，无需API密钥

### Open-Meteo Elevation API

获取地点海拔高度：

- 90米分辨率的全球数字高程模型
- 支持批量查询（最多100个坐标）
- 完全免费，无需API密钥

## 📝 示例数据

系统包含示例地点：

- **地点名称**：高新-丈八一路
- **纬度**：34.207012°N
- **经度**：108.860019°E
- **海拔**：约380-400米
- **时区**：Asia/Shanghai (UTC+8)

## 🔐 安全性

- **OAuth认证**：集成Manus OAuth，安全的用户认证
- **数据加密**：所有传输数据使用HTTPS加密
- **SQL注入防护**：使用Drizzle ORM防止SQL注入
- **CSRF防护**：tRPC自动处理CSRF令牌
- **安全头**：Nginx配置包含安全头（HSTS、X-Frame-Options等）

## 📈 性能优化

- **前端优化**：Vite构建，代码分割，懒加载
- **缓存策略**：气象数据缓存，静态文件长期缓存
- **数据库优化**：合理的索引设计，查询优化
- **Gzip压缩**：Nginx启用Gzip压缩，减少传输大小
- **CDN就绪**：静态资源可配置CDN加速

## 🧪 测试

```bash
# 运行单元测试
pnpm test

# 类型检查
pnpm check

# 代码格式化
pnpm format
```

## 📚 文档

- [DEPLOYMENT.md](./DEPLOYMENT.md) - 详细的部署指南
- [ELEVATION_API_INTEGRATION.md](./ELEVATION_API_INTEGRATION.md) - 海拔API集成方案
- [todo.md](./todo.md) - 功能追踪列表

## 🤝 贡献

欢迎提交Issue和Pull Request！

## 📄 许可证

MIT License

## 📞 支持

如有问题或建议，请提交Issue或联系技术支持。

---

**最后更新**：2025年10月26日

**版本**：1.0.0

**作者**：Manus AI Assistant

