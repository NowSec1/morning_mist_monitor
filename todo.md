# 晨雾监测系统 - 项目TODO

## 核心功能

### 晨雾/平流雾概率预测
- [x] 实现晨雾概率计算算法
- [x] 实现平流雾概率计算算法
- [x] 基于气象数据的风险等级评估
- [x] 影响因素分析（湿度、风速、温度-露点差、温度趋势）
- [x] 前端展示晨雾预测结果

### 日出时间与摄影时刻
- [x] 实现日出时间计算（天文学算法）
- [x] 实现蓝调时刻计算（日出前30分钟至日出后20分钟）
- [x] 实现金色时刻计算（日出前10分钟至日出后60分钟）
- [x] 前端精确到分钟的时间显示
- [ ] 交互式时间轴可视化（鼠标悬停显示具体时间）

### 详细气象数据展示
- [x] 获取日出前后2小时的小时级气象数据
- [x] 展示温度、相对湿度、露点、风速、天气代码、云量
- [x] 计算温度-露点差值
- [x] 关键指标高亮显示（高湿度、微风、温度-露点差值小、雾天气）
- [x] 前端气象数据表格展示
- [x] 修复温-露差数据显示问题（v1.3.2）

### 大气云层剖面图
- [x] 展示日出时刻的低、中、高云层覆盖率
- [x] 云层变化趋势分析（日出前后1小时）
- [x] 云层高度说明（0-2000m, 2000-6000m, 6000m+）
- [x] 海拔高度提示

### 地点配置功能
- [x] 用户自定义监测地点名称、纬度、经度
- [x] WGS-84坐标系提示
- [x] 配置信息本地存储（数据库存储）
- [x] 地点列表显示和选择
- [x] 地点编辑功能（待实现）
- [x] 地点删除功能（待实现）

### 算法模型说明
- [x] 独立的"算法说明"标签页
- [x] 日出时间计算算法详细说明
- [x] 晨雾/平流雾概率计算算法说明
- [x] 摄影时刻计算说明
- [x] 交互式可视化说明
- [x] 大气云层剖面图说明
- [x] 云层高度信息说明
- [x] 算法精度和局限性说明

## 优化/改进功能

### 海拔修正
- [x] 集成Open-Meteo Elevation API
- [x] 自动获取地点海拔
- [x] 海拔修正算法（每升高100米，低云层覆盖率降低1-2%）
- [x] 前端"自动获取"按钮
- [ ] 用户手动输入海拔选项

### 更详细的云层数据
- [x] 获取低、中、高三层云量数据
- [x] 云层变化趋势分析
- [x] 云层高度说明
- [ ] 集成更高分辨率的云层数据源（NOAA GFS、Sentinel-5P等）
- [ ] 云底/云顶高度估算
### 前端 UI/UX
- [x] 响应式设计
- [x] 深色/浅色主题支持
- [x] 雾天气风险等级颜色编码
- [x] 地点选择器组件
- [x] 晨雾预测显示组件
- [x] 气象数据表格组件
- [x] 云层可视化组件
- [x] 算法说明组件
- [x] 天气预警通知组件（晨雾概率>80%）
- [ ] 交互式时间轴可视化
- [ ] 地点编辑对话框
- [ ] 地点删除确认对话框

### 后端API
- [x] 地点管理API（创建、读取、更新、删除）
- [x] 气象数据获取API
- [x] 晨雾预测API
- [x] 云层数据API
- [x] 算法说明API
- [x] 海拔获取API
- [ ] 地点编辑API
- [ ] 地点删除API
- [ ] 预测结果缓存

### 数据库
- [x] 用户表
- [x] 监测地点表（包含海拔字段）
- [x] 气象数据缓存表
- [x] 晨雾预测结果表
- [x] 查询历史表
- [ ] 用户偏好设置表

## 部署和测试

### Docker部署
- [x] 编写Dockerfile
- [x] 编写docker-compose.yml
- [x] 配置Nginx反向代理
- [x] 环境变量配置
- [x] 数据库初始化脚本

### 测试
- [ ] 单元测试（算法模块）
- [ ] 集成测试（API接口）
- [ ] E2E测试（用户流程）
- [ ] 性能测试
- [ ] 浏览器兼容性测试

### 文档
- [x] 海拔API集成文档
- [x] API文档
- [x] 部署指南
- [x] 用户使用指南
- [x] 开发者指南

## 已知问题和改进点

### Bug修复
- [x] 气象数据页面 toFixed() 错误（查询数据为 undefined）
- [x] tRPC API 返回 HTML 而不是 JSON（后端服务错误）
- [x] 日出/蓝调/金色时刻时间显示错误（修复时区转换问题）
- [x] 风险等级改为概率等级

### 功能改进
- [x] 集成 SunriseSunset.io API 获取日出、日落、金色时刻数据
- [x] 未来3-7天晨雾预报（概率变化趋势图表）
- [ ] 时间轴可视化需要实现
- [ ] 地点编辑功能需要实现
- [ ] 地点删除功能需要实现
- [ ] 云层数据精度可以进一步提升
- [ ] 缓存机制可以优化性能
- [ ] 错误处理和用户提示可以更友好

## 示例数据

- 示例位置：高新-丈八一路
- 纬度：34.207012°N
- 经度：108.860019°E
- 海拔：约380-400米（待获取）
- 时区：Asia/Shanghai (UTC+8)




## 预警通知订阅功能（v1.4.0）

### 功能需求
- [x] 支持钉钉群机器人推送
- [x] 支持PushDeer推送
- [x] 用户配置通知阈值（默认80%）
- [x] 用户管理多个通知渠道
- [x] 通知历史记录
- [x] 通知开关控制

### 数据库
- [x] 创建通知配置表（notification_configs）
- [x] 创建通知历史表（notification_history）

### 后端实现
- [x] 创建通知服务模块（NotificationService）
- [x] 实现钉钉群机器人推送
- [x] 实现PushDeer推送
- [x] 添加通知配置API
- [x] 添加通知历史查询API
- [x] 添加通知路由模块

### 前端实现
- [x] 创建通知配置管理组件
- [x] 在首页添加预警通知标签页
- [x] 显示已配置的通知渠道
- [x] 显示最近的通知历史
- [x] 支持添加/编辑/删除通知配置

### 测试
- [x] 通知服务单元测试（12个测试用例）
- [x] 通知路由集成测试（20个测试用例）

